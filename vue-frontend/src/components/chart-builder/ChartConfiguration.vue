<template>
  <a-card title="3Îã®Í≥Ñ: Ï∞®Ìä∏ ÏÑ§Ï†ï" style="margin-bottom: 24px">
    <a-form layout="vertical">
      <!-- Í∏∞Î≥∏ Î©îÌä∏Î¶≠ ÏÑ§Ï†ï -->
      <a-card title="Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï" style="margin-bottom: 16px">
        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="Î©îÌä∏Î¶≠ *" required>
              <a-select
                v-model:value="config.metrics"
                mode="multiple"
                placeholder="Ï∏°Ï†ïÌï† Î©îÌä∏Î¶≠ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                :loading="metricsLoading"
                :options="metricOptions"
                :filter-option="filterOption"
                show-search
                style="width: 100%"
              >
                <template #optionRender="{ option }">
                  <div>
                    <strong>{{ option.label }}</strong>
                    <div style="font-size: 12px; color: #666">{{ option.group }}</div>
                  </div>
                </template>
              </a-select>
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="Í∑∏Î£π Í∏∞Ï§Ä">
              <a-select
                v-model:value="config.groupby"
                mode="multiple"
                placeholder="Í∑∏Î£πÌôîÌï† Ïª¨ÎüºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                :options="categoricalColumnOptions"
                :filter-option="filterOption"
                show-search
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
        </a-row>

        <a-row :gutter="16" v-if="isTimeSeriesChart">
          <a-col :span="12">
            <a-form-item label="ÏãúÍ∞Ñ Ïª¨Îüº">
              <a-select
                v-model:value="config.granularity_sqla"
                placeholder="ÏãúÍ∞Ñ Í∏∞Ï§Ä Ïª¨ÎüºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                :options="dateColumnOptions"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="ÏãúÍ∞Ñ Î≤îÏúÑ">
              <a-select
                v-model:value="config.time_range"
                placeholder="ÏãúÍ∞Ñ Î≤îÏúÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                :options="timeRangeOptions"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
        </a-row>
      </a-card>

      <!-- ÌëúÏãú ÏòµÏÖò -->
      <a-card title="ÌëúÏãú ÏòµÏÖò" style="margin-bottom: 16px">
        <a-row :gutter="16">
          <a-col :span="12">
            <a-form-item label="Ìñâ Ï†úÌïú">
              <a-input-number
                v-model:value="config.row_limit"
                :min="10"
                :max="10000"
                :step="100"
                placeholder="ÌëúÏãúÌï† Ìñâ Ïàò"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item label="ÏÉâÏÉÅ ÌÖåÎßà">
              <a-select
                v-model:value="config.color_scheme"
                placeholder="ÏÉâÏÉÅ ÌÖåÎßàÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî"
                :options="colorSchemeOptions"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
        </a-row>

        <!-- Ï∞®Ìä∏Î≥Ñ ÌäπÏàò ÏòµÏÖò -->
        <a-row :gutter="16" v-if="chartConfig.viz_type === 'table'">
          <a-col :span="12">
            <a-form-item label="ÌéòÏù¥ÏßÄ ÌÅ¨Í∏∞">
              <a-input-number
                v-model:value="config.page_length"
                :min="10"
                :max="500"
                :step="10"
                placeholder="ÌéòÏù¥ÏßÄÎãπ Ìñâ Ïàò"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item>
              <template #label>
                <span>Í≤ÄÏÉâ Í∏∞Îä• Ìè¨Ìï®</span>
              </template>
              <a-switch
                v-model:checked="config.include_search"
                checked-children="ON"
                un-checked-children="OFF"
              />
            </a-form-item>
          </a-col>
        </a-row>

        <a-row :gutter="16" v-if="chartConfig.viz_type === 'pie'">
          <a-col :span="12">
            <a-form-item label="ÎùºÎ≤® ÌòïÏãù">
              <a-select
                v-model:value="config.pie_label_type"
                :options="[
                  { label: 'ÌÇ§Í∞í', value: 'key' },
                  { label: 'ÌçºÏÑºÌä∏', value: 'percent' },
                  { label: 'ÌÇ§Í∞íÍ≥º ÌçºÏÑºÌä∏', value: 'key_percent' },
                  { label: 'ÌÇ§Í∞íÍ≥º Í∞í', value: 'key_value' }
                ]"
                style="width: 100%"
              />
            </a-form-item>
          </a-col>
        </a-row>

        <a-row :gutter="16" v-if="['line', 'area', 'scatter'].includes(chartConfig.viz_type)">
          <a-col :span="12">
            <a-form-item>
              <template #label>
                <span>ÎßàÏª§ ÌëúÏãú</span>
              </template>
              <a-switch
                v-model:checked="config.show_markers"
                checked-children="ON"
                un-checked-children="OFF"
              />
            </a-form-item>
          </a-col>
          <a-col :span="12">
            <a-form-item>
              <template #label>
                <span>Î≤îÎ°Ä ÌëúÏãú</span>
              </template>
              <a-switch
                v-model:checked="config.show_legend"
                checked-children="ON"
                un-checked-children="OFF"
              />
            </a-form-item>
          </a-col>
        </a-row>
      </a-card>

      <!-- ÏÑ§Ï†ï ÏöîÏïΩ -->
      <a-card title="ÏÑ§Ï†ï ÏöîÏïΩ" style="margin-bottom: 16px">
        <a-descriptions :column="2" size="small">
          <a-descriptions-item label="Î©îÌä∏Î¶≠">
            <span v-if="config.metrics?.length">
              {{ config.metrics.length }}Í∞ú ÏÑ†ÌÉùÎê®
            </span>
            <span v-else style="color: #ff4d4f">ÏÑ†ÌÉù ÌïÑÏöî</span>
          </a-descriptions-item>
          <a-descriptions-item label="Í∑∏Î£π Í∏∞Ï§Ä">
            <span v-if="config.groupby?.length">
              {{ config.groupby.length }}Í∞ú ÏÑ†ÌÉùÎê®
            </span>
            <span v-else style="color: #999">ÏÑ†ÌÉù ÏïàÎê®</span>
          </a-descriptions-item>
          <a-descriptions-item label="Ìñâ Ï†úÌïú">
            {{ config.row_limit || 1000 }}Ìñâ
          </a-descriptions-item>
          <a-descriptions-item label="ÏÉâÏÉÅ ÌÖåÎßà">
            {{ getColorSchemeName() }}
          </a-descriptions-item>
        </a-descriptions>
      </a-card>
    </a-form>
  </a-card>
</template>

<script>
import { defineComponent, ref, computed, watch, onMounted, nextTick } from 'vue'
import { message } from 'ant-design-vue'
import supersetAPI from '../../services/supersetAPI'

export default defineComponent({
  name: 'ChartConfiguration',
  props: {
    chartConfig: {
      type: Object,
      required: true
    },
    datasetColumns: {
      type: Array,
      default: () => []
    },
    selectedDataset: {
      type: Object,
      default: null
    }
  },
  emits: ['update', 'next', 'back'],
  setup(props, { emit }) {
    const config = ref({
      metrics: [],
      groupby: [],
      granularity_sqla: '',
      time_range: 'Last 30 days',
      page_length: 100,
      include_search: true,
      order_desc: 'desc',
      row_limit: 1000,
      show_markers: true,
      show_legend: true,
      pie_label_type: 'key_value',
      color_scheme: 'bnbColors',
      chart_height: 400
    })

    const metricsLoading = ref(false)
    const datasetMetrics = ref([])
    const isInitialized = ref(false) // üî• Ï¥àÍ∏∞Ìôî ÏÉÅÌÉú Ï∂îÏ†Å

    // Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄÎ•º ÏúÑÌïú ÌîåÎûòÍ∑∏
    const isUpdatingFromProps = ref(false)

    // ÏãúÍ≥ÑÏó¥ Ï∞®Ìä∏ Ïó¨Î∂Ä ÌôïÏù∏
    const isTimeSeriesChart = computed(() => {
      return ['line', 'area'].includes(props.chartConfig.viz_type)
    })

    // ÏÑ§Ï†ï Ïú†Ìö®ÏÑ± ÌôïÏù∏
    const isConfigValid = computed(() => {
      return config.value.metrics && config.value.metrics.length > 0
    })

    // Î©îÌä∏Î¶≠ ÏòµÏÖò ÏÉùÏÑ±
    const metricOptions = computed(() => {
      const options = []

      // 1. Í∏∞Î≥∏ ÏßëÍ≥Ñ Ìï®Ïàò (COUNT(*) Îì±)
      options.push({
        label: 'COUNT(*)',
        value: 'count',
        group: 'Í∏∞Î≥∏ ÏßëÍ≥Ñ'
      })

      // 2. Îç∞Ïù¥ÌÑ∞ÏÖãÏóê Ï†ïÏùòÎêú Î©îÌä∏Î¶≠Ïù¥ ÏûàÎã§Î©¥ Ï∂îÍ∞Ä
      if (datasetMetrics.value && datasetMetrics.value.length > 0) {
        datasetMetrics.value.forEach(metric => {
          options.push({
            label: metric.metric_name || metric.label,
            value: metric.metric_name || metric.id,
            group: 'Îç∞Ïù¥ÌÑ∞ÏÖã Î©îÌä∏Î¶≠'
          })
        })
      }

      // 3. Ïà´ÏûêÌòï Ïª¨ÎüºÏóê ÎåÄÌïú ÏßëÍ≥Ñ Ìï®ÏàòÎì§
      const numericColumns = props.datasetColumns.filter(col => 
        ['INTEGER', 'FLOAT', 'NUMERIC', 'DECIMAL', 'BIGINT', 'DOUBLE', 'REAL'].includes(col.type?.toUpperCase())
      )

      numericColumns.forEach(col => {
        options.push({
          label: `SUM(${col.column_name})`,
          value: `sum__${col.column_name}`,
          group: 'Ìï©Í≥Ñ Ìï®Ïàò'
        })
        options.push({
          label: `AVG(${col.column_name})`,
          value: `avg__${col.column_name}`,
          group: 'ÌèâÍ∑† Ìï®Ïàò'
        })
        options.push({
          label: `MAX(${col.column_name})`,
          value: `max__${col.column_name}`,
          group: 'ÏµúÎåÄÍ∞í Ìï®Ïàò'
        })
        options.push({
          label: `MIN(${col.column_name})`,
          value: `min__${col.column_name}`,
          group: 'ÏµúÏÜåÍ∞í Ìï®Ïàò'
        })
      })

      // 4. Î¨∏ÏûêÌòï Ïª¨ÎüºÏóê ÎåÄÌïú ÏßëÍ≥Ñ Ìï®ÏàòÎì§
      const categoricalColumns = props.datasetColumns.filter(col => 
        ['VARCHAR', 'TEXT', 'STRING', 'CHAR'].includes(col.type?.toUpperCase())
      )

      categoricalColumns.forEach(col => {
        options.push({
          label: `COUNT(DISTINCT ${col.column_name})`,
          value: `count_distinct__${col.column_name}`,
          group: 'Í≥†Ïú†Í∞í Í∞úÏàò'
        })
      })

      return options
    })

    // Ïπ¥ÌÖåÍ≥†Î¶¨Ìòï Ïª¨Îüº ÏòµÏÖò
    const categoricalColumnOptions = computed(() => {
      return props.datasetColumns
        .filter(col => !['DATETIME', 'DATE', 'TIMESTAMP'].includes(col.type?.toUpperCase()))
        .map(col => ({
          label: col.column_name,
          value: col.column_name
        }))
    })

    // ÎÇ†Ïßú Ïª¨Îüº ÏòµÏÖò
    const dateColumnOptions = computed(() => {
      return props.datasetColumns
        .filter(col => ['DATETIME', 'DATE', 'TIMESTAMP'].includes(col.type?.toUpperCase()))
        .map(col => ({
          label: col.column_name,
          value: col.column_name
        }))
    })

    // ÏãúÍ∞Ñ Î≤îÏúÑ ÏòµÏÖò
    const timeRangeOptions = ref([
      { label: 'ÏßÄÎÇú 7Ïùº', value: 'Last 7 days' },
      { label: 'ÏßÄÎÇú 30Ïùº', value: 'Last 30 days' },
      { label: 'ÏßÄÎÇú 90Ïùº', value: 'Last 90 days' },
      { label: 'ÏßÄÎÇú 1ÎÖÑ', value: 'Last year' },
      { label: 'ÌïÑÌÑ∞ ÏóÜÏùå', value: 'No filter' }
    ])

    // ÏÉâÏÉÅ ÌÖåÎßà ÏòµÏÖò
    const colorSchemeOptions = ref([
      { label: 'Í∏∞Î≥∏', value: 'bnbColors' },
      { label: 'Google', value: 'googleCategory10c' },
      { label: 'D3 Category', value: 'd3Category10' },
      { label: 'Superset', value: 'superset' },
      { label: 'Tableau', value: 'tableau10' },
      { label: 'D3 Categorical', value: 'categoricalD3' }
    ])

    // Í≤ÄÏÉâ ÌïÑÌÑ∞ Ìï®Ïàò
    const filterOption = (input, option) => {
      return option.label.toLowerCase().includes(input.toLowerCase())
    }

    // ÏÉâÏÉÅ ÌÖåÎßà Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
    const getColorSchemeName = () => {
      const scheme = colorSchemeOptions.value.find(s => s.value === config.value.color_scheme)
      return scheme ? scheme.label : 'Í∏∞Î≥∏'
    }

    // Îç∞Ïù¥ÌÑ∞ÏÖã Î©îÌä∏Î¶≠ Î°úÎìú
    const loadDatasetMetrics = async () => {
      if (!props.selectedDataset?.id) return

      metricsLoading.value = true
      try {
        const metrics = await supersetAPI.getDatasetMetrics(props.selectedDataset.id)
        datasetMetrics.value = metrics || []
        console.log('Îç∞Ïù¥ÌÑ∞ÏÖã Î©îÌä∏Î¶≠:', metrics)
      } catch (error) {
        console.error('Î©îÌä∏Î¶≠ Î°úÎìú Ïò§Î•ò:', error)
        // ÏóêÎü¨Í∞Ä ÎÇòÎèÑ Í∏∞Î≥∏ ÏßëÍ≥Ñ Ìï®ÏàòÎäî ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏúºÎØÄÎ°ú ÏπòÎ™ÖÏ†ÅÏù¥ÏßÄ ÏïäÏùå
        datasetMetrics.value = []
      } finally {
        metricsLoading.value = false
      }
    }

    // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï Ìï®Ïàò Í∞úÏÑ†
    const setDefaultValues = () => {
      console.log('setDefaultValues Ìò∏Ï∂úÎê®, ÌòÑÏû¨ Ï∞®Ìä∏ ÌÉÄÏûÖ:', props.chartConfig.viz_type)
      
      // üî• Í∏∞Î≥∏ Î©îÌä∏Î¶≠ÏúºÎ°ú COUNT(*) ÏÑ§Ï†ï - Ìï≠ÏÉÅ ÏÑ§Ï†ïÎêòÎèÑÎ°ù Î≥¥Ïû•
      if (!config.value.metrics || config.value.metrics.length === 0) {
        config.value.metrics = ['count']
        console.log('Í∏∞Î≥∏ Î©îÌä∏Î¶≠ ÏÑ§Ï†ï:', config.value.metrics)
      }
      
      // üî• Ï∞®Ìä∏Î≥Ñ Í∏∞Î≥∏ ÏÑ§Ï†ïÍ∞í Ï∂îÍ∞Ä
      switch (props.chartConfig.viz_type) {
        case 'table':
          Object.assign(config.value, {
            page_length: 100,
            include_search: true,
            row_limit: 1000
          })
          break
        case 'dist_bar':
        case 'line':
        case 'area':
          Object.assign(config.value, {
            row_limit: 1000,
            color_scheme: 'bnbColors'
          })
          break
        case 'pie':
          Object.assign(config.value, {
            pie_label_type: 'key_value',
            color_scheme: 'bnbColors',
            row_limit: 1000
          })
          break
        case 'scatter':
          Object.assign(config.value, {
            row_limit: 1000,
            color_scheme: 'bnbColors'
          })
          break
      }
      
      console.log('Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï ÏôÑÎ£å:', config.value)
    }

    // üî• Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ Í∞úÏÑ†Îêú config Î≥ÄÍ≤Ω Í∞êÏßÄ
    watch(config, (newConfig) => {
      if (!isUpdatingFromProps.value && isInitialized.value) {
        console.log('config Î≥ÄÍ≤ΩÎê®, ÏÉÅÏúÑ Ïª¥Ìè¨ÎÑåÌä∏Ïóê Ï†ÑÎã¨:', newConfig)
        emit('update', { params: { ...newConfig } })
      }
    }, { deep: true })

    // üî• Ï∞®Ìä∏ ÌÉÄÏûÖ Î≥ÄÍ≤Ω Í∞êÏßÄ (Í∏∞Î≥∏Í∞í Ïû¨ÏÑ§Ï†ï)
    watch(() => props.chartConfig.viz_type, (newVizType, oldVizType) => {
      if (newVizType && newVizType !== oldVizType && isInitialized.value) {
        console.log('Ï∞®Ìä∏ ÌÉÄÏûÖ Î≥ÄÍ≤ΩÎê®:', oldVizType, '‚Üí', newVizType)
        setDefaultValues()
      }
    })

    // üî• props.chartConfig Î≥ÄÍ≤Ω Í∞êÏßÄ - Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ
    watch(() => props.chartConfig, (newConfig) => {
      console.log('props.chartConfig Î≥ÄÍ≤ΩÎê®:', newConfig)
      
      isUpdatingFromProps.value = true
      
      if (newConfig.params && Object.keys(newConfig.params).length > 0) {
        // Í∏∞Ï°¥ ÏÑ§Ï†ïÏù¥ ÏûàÏúºÎ©¥ Î°úÎìú (Í∏∞Ï°¥ Í∞í Î≥¥Ï°¥)
        console.log('Í∏∞Ï°¥ ÏÑ§Ï†ï Î°úÎìú:', newConfig.params)
        Object.assign(config.value, newConfig.params)
      } else if (isInitialized.value) {
        // Í∏∞Ï°¥ ÏÑ§Ï†ïÏù¥ ÏóÜÍ≥† Ïù¥ÎØ∏ Ï¥àÍ∏∞ÌôîÎêòÏóàÎã§Î©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        console.log('Í∏∞Ï°¥ ÏÑ§Ï†ï ÏóÜÏùå, Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï')
        setDefaultValues()
      }
      
      // Îã§Ïùå Ìã±ÏóêÏÑú ÌîåÎûòÍ∑∏ Ìï¥Ï†ú
      nextTick(() => {
        isUpdatingFromProps.value = false
      })
    }, { immediate: true, deep: true })

    // üî• Îç∞Ïù¥ÌÑ∞ÏÖã Î≥ÄÍ≤Ω Í∞êÏßÄ
    watch(() => props.selectedDataset, async (newDataset, oldDataset) => {
      if (newDataset && newDataset.id !== oldDataset?.id) {
        console.log('Îç∞Ïù¥ÌÑ∞ÏÖã Î≥ÄÍ≤ΩÎê®:', newDataset)
        await loadDatasetMetrics()
        // Îç∞Ïù¥ÌÑ∞ÏÖãÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ Î©îÌä∏Î¶≠ÏùÑ Îã§Ïãú Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
        if (isInitialized.value) {
          config.value.metrics = ['count']
        }
      }
    })

    // üî• Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú
    onMounted(async () => {
      console.log('ChartConfiguration ÎßàÏö¥Ìä∏Îê®')
      await loadDatasetMetrics()
      
      // Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï
      if (!props.chartConfig.params || Object.keys(props.chartConfig.params).length === 0) {
        setDefaultValues()
      }
      
      isInitialized.value = true
      console.log('Ï¥àÍ∏∞Ìôî ÏôÑÎ£å')
    })

    return {
      config,
      metricsLoading,
      isTimeSeriesChart,
      isConfigValid,
      metricOptions,
      categoricalColumnOptions,
      dateColumnOptions,
      timeRangeOptions,
      colorSchemeOptions,
      filterOption,
      getColorSchemeName
    }
  }
})
</script>

<style scoped>
.ant-select-selector {
  min-height: 32px;
}

.ant-descriptions-item-label {
  font-weight: 500;
}

.ant-card {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 16px;
}

.ant-card-head-title {
  font-weight: 600;
}

.ant-form-item-label > label {
  font-weight: 500;
}

/* ÌïÑÏàò ÏûÖÎ†• ÌïÑÎìú Ïä§ÌÉÄÏùº */
.ant-form-item-required::before {
  color: #ff4d4f;
}
</style>